# Checkout Page - API Contract

## Overview

This document defines the external API behavior for the checkout page feature. It specifies the exact request/response structures, error formats, and behavioral contracts of the backend APIs consumed by the checkout flow.

---

## 1. Batch Transaction API

### 1.1 Endpoint

**Method**: `POST`  
**Path**: `/trades/batch`  
**Base URL**: Managed by HTTP service  
**Authentication**: Managed by HTTP service via `BACKEND_API_KEY`

### 1.2 Request Headers

| Header        | Required | Value                   |
| ------------- | -------- | ----------------------- |
| Content-Type  | ✅ Yes   | `application/json`      |
| Authorization | ✅ Yes   | Handled by HTTP service |

### 1.3 Request Body

#### Structure

```typescript
{
  operations: Array<BatchOperation>; // Min: 1, Max: 100
}
```

#### Batch Operation Types

The `operations` array supports the following operation types:

##### 1.3.1 Create Transaction

```typescript
{
  type: "create",
  ref?: string,  // Optional reference ID for cross-operation linking
  data: {
    space_id: number,              // Required
    sender_id?: number | null,     // Optional
    sent_time?: string,            // Optional (ISO timestamp)
    sender_notes?: string,         // Optional
    number?: string                // Optional (auto-generated if omitted)
  }
}
```

**Notes**:

- `space_id` is **required** and must be obtained from environment variable
- Transaction status defaults to `TX_DRAFT` if not provided (should still be provided explicitly)
- Transaction number is auto-generated by backend if not provided

##### 1.3.2 Update Transaction

```typescript
{
  type: "update",
  id?: number,      // Transaction ID (use either id or idRef, not both)
  idRef?: string,   // Reference to transaction created in same batch
  data: {
    sender_id?: number | null,
    receiver_id?: number | null,
    handler_id?: number | null,
    sender_notes?: string,
    receiver_notes?: string,       // Used for customer information in checkout
    handler_notes?: string,
    description?: string,
    status?: string,
    sent_time?: string,
    received_time?: string,
    fee?: string,
    files?: Array<{
      name: string,
      path: string,
      size: number
    }>,
    tags?: string[],
    links?: Array<{
      url: string,
      title?: string,
      description?: string
    }>
  }
}
```

**Notes**:

- Must provide either `id` or `idRef`, not both
- For checkout flow, typically only `receiver_notes` is updated
- `receiver_notes` stores all customer information as plain text

##### 1.3.3 Create Transaction Detail

```typescript
{
  type: "createDetail",
  transactionId?: number,      // Transaction ID (use either transactionId or transactionIdRef)
  transactionIdRef?: string,   // Reference to transaction created in same batch
  data: {
    item_id: number,              // Required - Product ID
    model_type: TransactionDetailType,  // Required - See section 1.3.7
    quantity: number,             // Required - Min: 0, Max: none
    price: number,                // Required - Min: 0, Max: none
    discount?: number,            // Optional - Min: 0, Max: none (default: 0)
    weight?: number,              // Optional - Min: 0, Max: none
    sku?: string,                 // Optional - No max length
    name?: string,                // Optional - No max length
    notes?: string                // Optional
  }
}
```

**Notes**:

- Must provide either `transactionId` or `transactionIdRef`, not both
- `sku` and `name` are required by schema but have no length constraints
- For checkout, `model_type` is always `"SO"` (Sales Order)
- Backend does **not** validate price against current product price
- Backend does **not** validate stock availability
- Backend does **not** validate item existence

##### 1.3.4 Update Transaction Detail

```typescript
{
  type: "updateDetail",
  transactionId?: number,
  transactionIdRef?: string,
  detailId: number,              // Required - ID of detail to update
  data: {
    item_id?: number,
    model_type?: TransactionDetailType,
    quantity?: number,
    price?: number,
    discount?: number,
    weight?: number,
    sku?: string,
    name?: string,
    notes?: string
  }
}
```

##### 1.3.5 Delete Transaction Detail

```typescript
{
  type: "deleteDetail",
  transactionId?: number,
  transactionIdRef?: string,
  detailId: number               // Required - ID of detail to delete
}
```

##### 1.3.6 Delete Transaction

```typescript
{
  type: "delete",
  id?: number,
  idRef?: string
}
```

##### 1.3.7 Read Transactions

```typescript
{
  type: "read",
  ids: number[],                 // Min: 1, Max: 1000
  withDetails?: boolean          // Default: false, set to true to include transaction details
}
```

**Notes**:

- Use `withDetails: true` to include transaction line items in response
- Used for retrieving checkout history

#### Transaction Detail Types

```typescript
type TransactionDetailType =
  | "ITR" // Internal Transfer
  | "SO" // Sales Order (used for checkout)
  | "BILL" // Bill
  | "PAY" // Payment
  | "PO" // Purchase Order
  | "DMG" // Damage
  | "RTR" // Return
  | "TAX" // Tax
  | "UNDF"; // Undefined
```

**Checkout Usage**: Always use `"SO"` for customer checkout transactions.

**Backend Validation**: Backend validates that `model_type` is appropriate for the space/transaction context.

### 1.4 Reference System

The reference system enables cross-operation dependencies within a single batch request.

**How It Works**:

1. When creating a transaction with `ref: "tx-main"`, the backend stores the created transaction ID in an internal map
2. When updating/creating details with `idRef: "tx-main"`, the backend resolves the reference to the actual transaction ID
3. References are local to the batch request and resolved during execution

**Execution Order**: Operations are executed sequentially in the exact order provided in the array.

**Example**:

```typescript
{
  operations: [
    {
      type: "create",
      ref: "tx-main", // Create and store reference
      data: { space_id: 123 },
    },
    {
      type: "update",
      idRef: "tx-main", // Resolve reference to created transaction ID
      data: { receiver_notes: "Customer info..." },
    },
    {
      type: "createDetail",
      transactionIdRef: "tx-main", // Resolve same reference
      data: {
        item_id: 1,
        model_type: "SO",
        quantity: 2,
        price: 10000,
        sku: "SKU1",
        name: "Product 1",
      },
    },
  ];
}
```

**Error Handling**: If an `idRef` references a non-existent `ref`, a `500` error is returned.

**Response Correlation**: There is currently no field in the response that identifies which transaction corresponds to which `ref`. Correlation must be done manually by counting array positions (operations are executed in order, so responses maintain order).

### 1.5 Success Response

#### Structure

```typescript
{
  created: Transaction[],
  read: Transaction[],
  updated: Transaction[],
  deleted: number[],
  createdDetails: TransactionDetail[],
  updatedDetails: TransactionDetail[],
  deletedDetails: number[]
}
```

#### Response Ordering

- Items in `created`, `createdDetails`, etc. arrays are returned in the same order as the operations in the request
- This is guaranteed because operations execute sequentially

#### Transaction Schema

```typescript
{
  id: number,
  number: string,                    // Auto-generated transaction number (e.g., "TRX-2024-0001")
  space_id: number,
  status: string,                    // "TX_DRAFT", "TX_REQUEST", etc.
  total: string,                     // Calculated by backend
  sent_time?: string | null,
  received_time?: string | null,
  sender_id?: number | null,
  receiver_id?: number | null,
  handler_id?: number | null,
  parent_id?: number | null,
  sender_notes?: string,
  receiver_notes?: string,           // Customer information for checkout
  handler_notes?: string,
  description?: string,
  fee?: string,
  files?: Array<{
    name: string,
    path: string,
    size: number
  }>,
  tags?: string[],
  links?: Array<{
    url: string,
    title?: string,
    description?: string
  }>,
  details?: TransactionDetail[],     // Only populated if withDetails: true in read operation
  children?: ChildTransaction[],     // Only populated with special flags
  sender?: PlayerInfo | null,        // Only populated with special flags
  receiver?: PlayerInfo | null,
  handler?: PlayerInfo | null,
  all_notes?: string,
  created_at?: string | null,
  updated_at?: string | null
}
```

#### Transaction Detail Schema

```typescript
{
  id: number,
  sku?: string,
  name?: string,
  quantity: number,
  price: number,
  discount: number,
  weight: number,
  debit: number,                     // Calculated by backend
  credit: number,                    // Calculated by backend
  notes?: string,
  model_type?: string,
  item?: {                           // Populated if item exists in backend
    id: number,
    name: string,
    sku: string | null,
    cost: string,
    price: string
  }
}
```

#### Accessing Transaction Number

For checkout flow:

```typescript
const response = await batchTransaction({ operations: [...] });
const transactionNumber = response.created[0].number;
```

### 1.6 Error Responses

#### Error Format

All errors follow a standard format:

```typescript
{
  error: {
    code: string,
    message: string,
    details?: any
  }
}
```

#### HTTP Status Codes

| Status | Scenario                                                       |
| ------ | -------------------------------------------------------------- |
| `400`  | Validation error, exceeded operation limit, space access error |
| `401`  | Authentication failure, invalid/missing API key                |
| `500`  | Server error, batch atomicity failure, invalid reference       |

#### Specific Error Scenarios

##### Exceeded Operation Limit

**Condition**: More than 100 operations in batch  
**Status**: `400 Bad Request`  
**Response**:

```typescript
{
  error: {
    code: "VALIDATION_ERROR",
    message: "Operations array exceeds maximum limit of 100",
    details: { maxOperations: 100, provided: 150 }
  }
}
```

##### Invalid Reference

**Condition**: `idRef` references non-existent `ref`  
**Status**: `500 Internal Server Error`  
**Response**:

```typescript
{
  error: {
    code: "REFERENCE_ERROR",
    message: "Referenced transaction 'tx-main' not found in batch"
  }
}
```

##### Batch Atomicity Failure

**Condition**: Any operation in batch fails (e.g., operation 3 fails in batch of 5)  
**Status**: `500 Internal Server Error`  
**Behavior**:

- **All changes are rolled back** (no partial success)
- No transactions or details are created
- Error details include which operation failed

**Response**:

```typescript
{
  error: {
    code: "BATCH_EXECUTION_ERROR",
    message: "Operation 3 failed: ...",
    details: {
      failedOperation: 3,
      reason: "..."
    }
  }
}
```

##### Validation Errors

**Condition**: Field-level validation failures  
**Status**: `400 Bad Request`  
**Response**:

```typescript
{
  error: {
    code: "VALIDATION_ERROR",
    message: "Validation failed",
    details: {
      fields: {
        "operations[0].data.space_id": "Required field missing",
        "operations[2].data.quantity": "Must be greater than or equal to 0"
      }
    }
  }
}
```

##### Invalid Item ID

**Condition**: `item_id` in createDetail doesn't exist or is inaccessible  
**Status**: `500 Internal Server Error`  
**Note**: Backend currently does **not validate** item existence

##### Space Access Error

**Condition**: `space_id` doesn't exist or token lacks access  
**Status**: `400 Bad Request` or `401 Unauthorized`

##### Model Type Validation Error

**Condition**: `model_type` is invalid for the space/context  
**Status**: `400 Bad Request`  
**Note**: Backend **does validate** model type appropriateness

#### Field Validation Rules

| Field      | Rule                             | Error Status |
| ---------- | -------------------------------- | ------------ |
| quantity   | Must be ≥ 0                      | 400          |
| price      | Must be ≥ 0                      | 400          |
| discount   | Must be ≥ 0 (cannot be negative) | 400          |
| weight     | Must be ≥ 0                      | 400          |
| operations | Min: 1, Max: 100                 | 400          |
| ids (read) | Min: 1, Max: 1000                | 400          |

### 1.7 Performance Characteristics

| Characteristic   | Value                                   |
| ---------------- | --------------------------------------- |
| Timeout          | 30 seconds (recommended client timeout) |
| Backend Timeout  | None enforced (30s is appropriate)      |
| Rate Limiting    | None currently                          |
| Max Request Size | No limit                                |

### 1.8 Reliability Guarantees

#### Atomicity

All operations in a batch are **atomic**: either all succeed or all fail. There are no partial success states.

#### Idempotency

**Warning**: The batch operation is **NOT idempotent**. Sending the same batch twice will create duplicate transactions.

**No Idempotency Key**: There is currently no idempotency key mechanism.

**Retry Policy**:

- Wait **30 seconds** before retrying after an error
- Implement client-side deduplication if necessary
- Consider adding unique identifiers to prevent duplicates

---

## 2. Product Batch Read API

### 2.1 Endpoint

**Method**: `POST`  
**Path**: `/items/batch-read`  
**Base URL**: Managed by HTTP service  
**Authentication**: Uses same `BACKEND_API_KEY`

### 2.2 Request Headers

| Header        | Required | Value                   |
| ------------- | -------- | ----------------------- |
| Content-Type  | ✅ Yes   | `application/json`      |
| Authorization | ✅ Yes   | Handled by HTTP service |

### 2.3 Request Body

```typescript
{
  ids: number[]  // Array of product/item IDs
}
```

**Example**:

```typescript
{
  ids: [1, 2, 3, 5, 8];
}
```

### 2.4 Success Response

Returns an array of complete product objects with all fields:

```typescript
Product[]
```

**Example**:

```typescript
[
  {
    id: 1,
    name: "Product Name",
    sku: "SKU-123",
    price: "25000",
    cost: "15000",
    stock: 100,
    description: "...",
    images: [...],
    // ... all other product fields
  },
  ...
]
```

**Price Freshness**: Prices are **always latest** from the database.

### 2.5 Error Responses

Follows same error format as batch transaction API:

```typescript
{
  error: {
    code: string,
    message: string,
    details?: any
  }
}
```

**Status Codes**: Same as batch transaction API (`400`, `401`, `500`)

### 2.6 Usage in Checkout

The product batch read is used to:

1. Fetch fresh product data (name, price, SKU, stock) when loading checkout page
2. Validate product availability before checkout
3. Ensure prices used in transaction creation are current

**Client Responsibility**:

- Stock validation (backend does not validate)
- Price validation (backend accepts any price)
- Product existence validation (backend does not validate)

---

## 3. Checkout Flow API Sequence

### 3.1 Standard Checkout Flow

```
1. Client: POST /items/batch-read
   → Fetch product details for cart items

2. Client: Validate stock, calculate totals

3. Client: POST /trades/batch
   → Operation 1: Create transaction (ref: "tx-main")
   → Operation 2: Update transaction with receiver_notes
   → Operations 3+: Create detail for each cart item

4. Backend: Execute batch atomically

5. Backend: Return success response

6. Client: Extract transaction number from response.created[0].number

7. Client: Generate WhatsApp message

8. Client: Clear cart
```

### 3.2 Checkout History Retrieval

```
1. Client: Read transaction IDs from local checkout history store

2. Client: POST /trades/batch
   → Operation: { type: "read", ids: [123, 456, 789], withDetails: true }

3. Backend: Return transactions with details

4. Client: Display transaction history
```

---

## 4. Data Constraints

### 4.1 Backend-Enforced Constraints

| Constraint          | Enforcement | Details                              |
| ------------------- | ----------- | ------------------------------------ |
| Operations limit    | ✅ Backend  | Max 100 operations per batch         |
| Read IDs limit      | ✅ Backend  | Max 1000 IDs per read operation      |
| Model type validity | ✅ Backend  | Validates model type appropriateness |
| Negative discount   | ✅ Backend  | discount must be ≥ 0                 |
| Batch atomicity     | ✅ Backend  | All or nothing execution             |

### 4.2 Client-Side Constraints

| Constraint            | Responsibility | Rationale                           |
| --------------------- | -------------- | ----------------------------------- |
| Stock validation      | ✅ Client      | Backend does not check stock        |
| Price validation      | ✅ Client      | Backend accepts any price           |
| Product existence     | ✅ Client      | Backend does not validate item      |
| Empty cart prevention | ✅ Client      | Backend allows 0 details            |
| Duplicate item_id     | ✅ Client      | Should not create duplicate details |

### 4.3 Customer Information Storage

**Field**: `transaction.receiver_notes`  
**Format**: Plain text (no parsing or validation by backend)

**Checkout Format** (client-defined):

```
Full Name: <value>
Phone: <value>
Email: <value>
Street: <value>
City: <value>
Province: <value>
Postal Code: <value>
Notes: <value>
```

**Note**: This format is purely client-side convention. Backend stores as-is.

---

## 5. Environment Configuration

### 5.1 Required Environment Variables

| Variable          | Usage                                | Access Location |
| ----------------- | ------------------------------------ | --------------- |
| `BACKEND_API_KEY` | Authentication for all backend APIs  | Astro action    |
| `SPACE_ID`        | Required `space_id` for transactions | Astro action    |

### 5.2 Security Constraints

- These values **MUST** remain server-side only
- **MUST NOT** be exposed to client via public environment variables
- **MUST** only be accessed in Astro actions or API endpoints

**Correct Usage**:

```typescript
// In Astro action
const token = import.meta.env.BACKEND_API_KEY;
const spaceId = import.meta.env.SPACE_ID;
```

**Forbidden**:

```typescript
// ❌ NEVER expose to client
export const PUBLIC_BACKEND_API_KEY = "...";
```

---

## 6. Integration Notes

### 6.1 Astro Actions

The checkout page uses Astro actions as the integration layer:

**File**: `src/modules/checkout/actions/batch-transaction.action.ts`

```typescript
export const batchTransactionAction = defineAction({
  input: batchOperationsBodySchema,
  handler: async (input) => {
    const token = import.meta.env.BACKEND_API_KEY;
    return await batchTransaction({ token, body: input });
  },
});
```

### 6.2 HTTP Service

Base URL and authentication headers are abstracted by the HTTP service:

**File**: `src/shared/infrastructure/http`

- Manages base URL configuration
- Handles authentication header injection
- Provides consistent HTTP client

### 6.3 CORS Considerations

**None**: Astro actions run server-side, so CORS is not a concern for checkout API calls.

---

## 7. Future Considerations

### 7.1 Planned Backend Improvements

- **Stock validation**: Backend to validate quantity against stock
- **Idempotency keys**: Mechanism to prevent duplicate submissions
- **Reference correlation**: Response field to identify which transaction corresponds to which ref

### 7.2 Breaking Changes to Monitor

- Changes to batch operation structure
- Additional required fields
- Modified error response format
- Authentication mechanism changes

---

## Document Metadata

**Authority Level**: 4 (API Contract - External Behavior)  
**Constrained By**:

- [use-case.md](./use-case.md) (Intent)
- [requirements.md](./requirements.md) (Obligations)
- [constraints.md](./constraints.md) (Non-negotiables)

**Last Updated**: 2026-02-03  
**Reviewed By**: LinCie
